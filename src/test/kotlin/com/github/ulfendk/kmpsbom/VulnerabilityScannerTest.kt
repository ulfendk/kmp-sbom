package com.github.ulfendk.kmpsbom

import org.cyclonedx.model.Bom
import org.cyclonedx.model.Component
import org.gradle.api.logging.Logger
import org.junit.Test
import kotlin.test.assertNotNull
import kotlin.test.assertTrue

class VulnerabilityScannerTest {
    
    private val mockLogger = object : Logger by org.gradle.api.logging.Logging.getLogger("test") {
        override fun lifecycle(message: String?) {}
        override fun debug(message: String?) {}
        override fun info(message: String?) {}
        override fun warn(message: String?) {}
        override fun warn(message: String?, throwable: Throwable?) {}
    }
    
    private val mockExtension = KmpSbomExtension().apply {
        enableVulnerabilityScanning = true
        vulnerabilityScanners = "all"
    }
    
    @Test
    fun `scanner handles empty component list`() {
        val scanner = VulnerabilityScanner(mockLogger, mockExtension)
        val bom = Bom()
        val components = emptyList<Component>()
        
        scanner.scan(components, bom)
        
        // Should not set vulnerabilities on empty list
        assertTrue(bom.vulnerabilities == null || bom.vulnerabilities.isEmpty())
    }
    
    @Test
    fun `scanner filters non-maven components`() {
        val scanner = VulnerabilityScanner(mockLogger, mockExtension)
        val bom = Bom()
        
        // Create component without Maven PURL
        val component = Component()
        component.group = "swift.package"
        component.name = "SomeSwiftPackage"
        component.version = "1.0.0"
        component.purl = "pkg:swift/SomeSwiftPackage@1.0.0"
        component.bomRef = "swift-ref-1"
        
        val components = listOf(component)
        
        // This should not crash, but skip the component
        scanner.scan(components, bom)
        
        // No vulnerabilities should be found for non-Maven components
        assertTrue(bom.vulnerabilities == null || bom.vulnerabilities.isEmpty())
    }
    
    @Test
    fun `scanner handles components with valid Maven PURL`() {
        val scanner = VulnerabilityScanner(mockLogger, mockExtension)
        val bom = Bom()
        
        // Create a component with Maven PURL
        val component = Component()
        component.group = "org.apache.commons"
        component.name = "commons-text"
        component.version = "1.9"
        component.purl = "pkg:maven/org.apache.commons/commons-text@1.9"
        component.bomRef = "maven-ref-1"
        
        val components = listOf(component)
        
        // This should make a real API call to OSS Index
        // Note: This is an integration test that requires network access
        scanner.scan(components, bom)
        
        // We can't guarantee vulnerabilities will be found, but the scan should complete
        assertNotNull(bom)
    }
    
    @Test
    fun `scanner processes multiple components in batches`() {
        val scanner = VulnerabilityScanner(mockLogger, mockExtension)
        val bom = Bom()
        
        // Create multiple components
        val components = (1..5).map { i ->
            Component().apply {
                group = "org.example"
                name = "library-$i"
                version = "1.0.0"
                purl = "pkg:maven/org.example/library-$i@1.0.0"
                bomRef = "maven-ref-$i"
            }
        }
        
        // This should batch components and make API calls
        scanner.scan(components, bom)
        
        // Scan should complete without error
        assertNotNull(bom)
    }
    
    @Test
    fun `scanner handles network failures gracefully`() {
        val scanner = VulnerabilityScanner(mockLogger, mockExtension)
        val bom = Bom()
        
        // Create component with valid format but potentially no network
        val component = Component()
        component.group = "org.example"
        component.name = "test-lib"
        component.version = "1.0.0"
        component.purl = "pkg:maven/org.example/test-lib@1.0.0"
        component.bomRef = "maven-ref-test"
        
        val components = listOf(component)
        
        // Should handle any network errors gracefully
        scanner.scan(components, bom)
        
        // Should not throw exception
        assertNotNull(bom)
    }
    
    @Test
    fun `scanner respects ossindex-only configuration`() {
        val extension = KmpSbomExtension().apply {
            enableVulnerabilityScanning = true
            vulnerabilityScanners = "ossindex"
        }
        val scanner = VulnerabilityScanner(mockLogger, extension)
        val bom = Bom()
        
        val component = Component().apply {
            group = "org.example"
            name = "test-lib"
            version = "1.0.0"
            purl = "pkg:maven/org.example/test-lib@1.0.0"
            bomRef = "maven-ref-test"
        }
        
        scanner.scan(listOf(component), bom)
        
        // Should complete without error
        assertNotNull(bom)
    }
    
    @Test
    fun `scanner respects github-only configuration`() {
        val extension = KmpSbomExtension().apply {
            enableVulnerabilityScanning = true
            vulnerabilityScanners = "github"
        }
        val scanner = VulnerabilityScanner(mockLogger, extension)
        val bom = Bom()
        
        val component = Component().apply {
            group = "org.example"
            name = "test-lib"
            version = "1.0.0"
            purl = "pkg:maven/org.example/test-lib@1.0.0"
            bomRef = "maven-ref-test"
        }
        
        scanner.scan(listOf(component), bom)
        
        // Should complete without error (will skip GitHub if no token)
        assertNotNull(bom)
    }
}
